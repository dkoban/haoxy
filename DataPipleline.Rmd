---
title: "Hoaxy Data Pipeline"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

The following document describes an automated workflow for the following tasks:

1. Collect Tweet data from Hoaxy
2. Enrich Twitter user accounts with profile information
3. Generate time series data for us in Vensim

## Load libraries and functions

```{r cars}
library(tidyverse)
library(stringr)
library(hoaxy)
library(RColorBrewer)
library(scales)
source("~/Documents/hoaxy/functions.R")
hoaxy_key('')
```

## Query Hoaxy for recent articles

```{r}
articles <- hx_latest_articles(past_hours = 30)
articles$tag <- extract_misinfo_tags(articles)
```

## Filter article list for likely misinformation stories

```{r}
misinfo_tags <- c("clickbait", "conspiracy", "junksci", 
                  "junkscience", "hoax", "fake")
articles <- articles %>% filter(tag %in% misinfo_tags)
articles$tag %>% table()
```

## Query articles for Hoaxy edges

Print sample headlines categorized as conspiracies.

```{r}
articles <- articles %>% filter(tag == "conspiracy")
articles$title[1:10]
```

Query Hoaxy for edges

```{r}
edges <- list()
for (i in 1:10){
edges[[i]] <- hx_edges(articles$id[i], nodes_limit = 50000)
print(paste0("Query ", i, " complete: ", nrow(edges[[i]]), " records"))
}
```

The story with the most tweet activity was:

```{r}
articles$title[edges %>% lapply(nrow) %>% unlist() %>% which.max()]
```

## Hoaxy edge data

List column names

```{r}
top_article <- edges[[edges %>% lapply(nrow) %>% unlist() %>% which.max()]]
top_article <- top_article %>% as_tibble()
top_article %>% colnames()
```

Count tweet activity by type

```{r}
top_article %>% count(tweet_type)
```

Plot tweet activty by date and time

```{r}
top_article <- top_article %>% 
  mutate(tweet_created_at = tweet_created_at %>% 
           as.POSIXct(format = "%Y-%m-%dT%H:%M:%S.000Z"))

ggplot(data = top_article,
         mapping = aes(x = tweet_created_at,
                       y = tweet_type)) +
    geom_jitter(size = 0.2) + 
    scale_x_datetime(breaks=date_breaks("24 hour"), labels=date_format("%m-%d")) +
    labs(title = top_article$title[1],
         x = "Tweet Created At",
         y = "Tweet Type")
```


